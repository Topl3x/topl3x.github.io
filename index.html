<!DOCTYPE html>
<html>

<head>
  <title>Perceptual Study</title>
  <script src="https://unpkg.com/jspsych@8.2.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@2.1.0"></script>
  <link href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css" rel="stylesheet" type="text/css" />
  <style>
    #jspsych-progressbar-container { 
      margin: 4px 0 6px !important;
    }

    .jspsych-html-slider-response-stimulus { 
      margin-top: 0 !important; 
    }

    .jspsych-html-slider-response-container { 
      margin-top: 6px !important;
    }

    .jspsych-content > *:first-child { 
      margin-top: 0 !important; 
    }
  </style>
</head>

<body></body>

<script>
  const sheetURL = 'https://script.google.com/macros/s/AKfycbx8mwFKl1WHv84QkM4LblyCeo4UOBasZub5rMwazom52bwJ1ydoXuT0Sa4XGC0jLNgvxw/exec';
  const jsPsych = initJsPsych({
    show_progress_bar: true,
    on_finish: function () {
      document.body.innerHTML = `
        <div style="max-width:700px;margin:40px auto;font-family:system-ui;text-align:center">
          <h2>Saving your responsesâ€¦</h2>
          <p>Please don't close this tab.</p>
        </div>`;
      const data = jsPsych.data.get().json();
      fetch(sheetURL, {
        method: 'POST',
        // mode: 'no-cors',
        headers: {
          'Content-Type': 'text/plain'
        },
        body: data,
        keepalive: true
      }).finally(() => {
        window.location.replace('thankyou.html');
      });
      // jsPsych.data.displayData();
    }
  });

  jsPsych.data.addProperties({
    screen_width:  screen.width,
    screen_height: screen.height,
    window_width:  window.innerWidth,
    window_height: window.innerHeight,
    device_pixel_ratio: window.devicePixelRatio,
    user_agent: navigator.userAgent,
    device: /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent) ? 'mobile' : 'desktop'
  });

  const timeline = [];

  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <h2>Welcome!</h2>
      <p>This study explores visual perception of rendered avatars. It will take about 5 minutes.</p>
      <p>Your task is to rate each image on a scale of 0-100 by comparing a toggleable reference image.</p>
      <p>By continuing, you consent to participate anonymously.</p>
    `,
    choices: ['I Agree']
  });

  timeline.push({
    type: jsPsychSurveyHtmlForm,
    html: `
      <p>Gender:
        <select name="gender" required>
          <option value="male">Male</option>
          <option value="female">Female</option>
          <option value="nonbinary">Non-binary</option>
          <option value="other">Other</option>
        </select>
      </p>
      <p>Age: <input name="age" type="number" min="0" max ="120" required></p>
    `,
    button_label: 'Start'
  });

  var preload = {
    type: jsPsychPreload,
    images: [
      'images/A_0_25_0.png',  
      'images/A_0_50_1.png',
      'images/A_0_100.png',   
      'images/B_0_25_2.png',  
      'images/B_0_50_3.png',
      'images/B_0_100.png',   
      'images/B_1_25_4.png',  
      'images/B_1_50_5.png',  
      'images/B_2_25_6.png',  
      'images/B_2_50_7.png', 
      'images/C_0_25_8.png', 
      'images/C_0_50_9.png', 
      'images/C_0_100.png',
      'images/C_1_25_10.png',
      'images/C_1_50_11.png',
      'images/C_2_25_12.png',
      'images/C_2_50_13.png',
      'images/D_0_25_14.png',
      'images/D_0_50_15.png',
      'images/D_0_100.png',
      'images/D_1_25_16.png',
      'images/D_1_50_17.png',
      'images/D_2_25_18.png',
      'images/D_2_50_19.png'
    ]
  }

  const imagePairs = [
    { evaluation: 'images/A_0_25_0.png',  reference: 'images/A_0_100.png' },
    { evaluation: 'images/A_0_50_1.png',  reference: 'images/A_0_100.png' },
    { evaluation: 'images/B_0_25_2.png',  reference: 'images/B_0_100.png' },
    { evaluation: 'images/B_0_50_3.png',  reference: 'images/B_0_100.png' },
    { evaluation: 'images/B_1_25_4.png',  reference: 'images/B_0_100.png' },
    { evaluation: 'images/B_1_50_5.png',  reference: 'images/B_0_100.png' },
    { evaluation: 'images/B_2_25_6.png',  reference: 'images/B_0_100.png' },
    { evaluation: 'images/B_2_50_7.png',  reference: 'images/B_0_100.png' },
    { evaluation: 'images/C_0_25_8.png',  reference: 'images/C_0_100.png' },
    { evaluation: 'images/C_0_50_9.png',  reference: 'images/C_0_100.png' },
    { evaluation: 'images/C_1_25_10.png', reference: 'images/C_0_100.png' },
    { evaluation: 'images/C_1_50_11.png', reference: 'images/C_0_100.png' },
    { evaluation: 'images/C_2_25_12.png', reference: 'images/C_0_100.png' },
    { evaluation: 'images/C_2_50_13.png', reference: 'images/C_0_100.png' },
    { evaluation: 'images/D_0_25_14.png', reference: 'images/D_0_100.png' },
    { evaluation: 'images/D_0_50_15.png', reference: 'images/D_0_100.png' },
    { evaluation: 'images/D_1_25_16.png', reference: 'images/D_0_100.png' },
    { evaluation: 'images/D_1_50_17.png', reference: 'images/D_0_100.png' },
    { evaluation: 'images/D_2_25_18.png', reference: 'images/D_0_100.png' },
    { evaluation: 'images/D_2_50_19.png', reference: 'images/D_0_100.png' }
  ];

  function createImageTrial(evaluation, reference) {
    let handleKey;
    return {
      type: jsPsychHtmlSliderResponse,
      stimulus: `
        <div style="display: flex; align-items: center; justify-content: center;">
          <div>
            <img id="image" src="${evaluation}" style="max-width: 90vw; max-height: 83vh; width: auto; height: auto; object-fit: contain;" />
          </div>
          <div id="right-panel" style="margin-left: auto;">
            <p>Please compare to reference image.</p>
            <button id="ref-btn" type="button">Show Reference<br>[SPACE]</button>
            <div id="slider-container" style="display: flex;"></div>
            <div id="slider-value" style="font-weight:bold;">Value: 50</div>
            <div id="continue-button"></div>
          </div>
        </div>
      `,
      // labels: ['0', '20', '40', '60', '80', '100'],
      min: 0,
      max: 100,
      start: 50,
      step: 1,
      // slider_width: 20,
      // require_movement: true,
      button_label: 'Continue',

      on_load: () => {
        const img = document.getElementById('image');
        const btn = document.getElementById('ref-btn');
        btn.style.width = '115px';
        const submitBtn = document.querySelector('.jspsych-btn');
        handleKey = (e) => {
          if(e.code === 'Space') {
            e.preventDefault();
            btn.click();
          }
        };

        document.addEventListener('keydown', handleKey);

        const slider = document.querySelector('input[type="range"]');
        const sliderContainer = document.querySelector('#slider-container');
        const continueContainer = document.querySelector('#continue-button');
        const valueDisplay = document.getElementById('slider-value');
        const sliderWrapper = slider.parentElement;
        const panel = document.getElementById('ref-btn').parentElement;

        const sliderRow = document.createElement('div');
        sliderRow.style.display = 'flex';
        sliderRow.style.alignItems = 'center';
        sliderRow.style.gap = '6px';
        sliderRow.style.justifyContent = 'center';

        panel.insertBefore(sliderRow, sliderContainer);
        sliderRow.appendChild(sliderContainer);

        sliderContainer.style.width = '0px';
        sliderContainer.style.height = '500px';
        sliderContainer.style.position = 'relative';
        sliderContainer.style.display = 'inline-block';
        sliderContainer.style.overflow = 'visible';
        sliderContainer.style.margin = '20px';
        sliderContainer.style.padding = '0';

        const rotor = document.createElement('div');
        rotor.style.position = 'absolute';
        rotor.style.left = '50%';
        rotor.style.top = '50%';
        rotor.style.transform = 'translate(-50%, -50%) rotate(-90deg)';
        rotor.style.transformOrigin = 'center center';
        rotor.style.width = '500px';
        rotor.style.height = '30px';
        rotor.style.display = 'flex';
        rotor.style.alignItems = 'center';
        rotor.style.justifyContent = 'center';

        sliderWrapper.style.margin = '0';
        sliderWrapper.style.padding = '0';
        sliderWrapper.style.display = 'flex';
        sliderWrapper.style.alignItems = 'center';
        sliderWrapper.style.justifyContent = 'center';
        rotor.appendChild(sliderWrapper);
        sliderContainer.appendChild(rotor);

        slider.style.width = '500px';
        slider.style.height = '30px';
        slider.style.margin = '0';
        slider.style.padding = '0';
        slider.style.display = 'block';
        slider.style.transform = 'none';

        const tickCol = document.createElement('div');
        tickCol.style.display = 'flex';
        tickCol.style.flexDirection = 'column';
        tickCol.style.justifyContent = 'space-between';
        tickCol.style.height = '500px';
        tickCol.style.marginLeft = '0px';
        tickCol.style.fontSize = '13px';
        tickCol.style.lineHeight = '1.1';
        tickCol.style.userSelect = 'none';
        tickCol.style.webkitUserSelect = 'none';
        tickCol.style.MozUserSelect = 'none';
        tickCol.style.msUserSelect = 'none';  
        tickCol.style.alignItems = 'flex-start';
        tickCol.style.textAlign = 'left';

        tickCol.style.pointerEvents = 'none';
        tickCol.innerHTML = `
          <span>100</span>
          <span>&nbsp;&nbsp;Excellent</span>
          <span>80</span>
          <span>&nbsp;&nbsp;Good</span>
          <span>60</span>
          <span>&nbsp;&nbsp;Fair</span>
          <span>40</span>
          <span>&nbsp;&nbsp;Poor</span>
          <span>20</span>
          <span>&nbsp;&nbsp;Bad</span>
          <span>0</span>
        `;
        sliderRow.appendChild(tickCol);

        continueContainer.append(document.querySelector('.jspsych-btn'));

        let showingRef = false;
        let seenRef = false;
        let sliderMoved = false;

        submitBtn.disabled = true;

        function updateSubmitState() {
          submitBtn.disabled = !(sliderMoved && seenRef);
        }

        btn.style.whiteSpace = 'pre-line';
        btn.addEventListener('click', () => {
          showingRef = !showingRef;
          seenRef = true;

          if (showingRef) {
            img.src = reference;
            btn.textContent = 'Show Original\n[SPACE]';
            // slider.disabled = true;
            // valueDisplay.style.opacity = '0.5';
          } else {
            img.src = evaluation;
            btn.textContent = 'Show Reference\n[SPACE]';
            // slider.disabled = false;
            // valueDisplay.style.opacity = '1.0';
          }
          updateSubmitState();
        });

        slider.addEventListener('input', () => {
          valueDisplay.textContent = `Value: ${slider.value}`;
          sliderMoved = true;
          updateSubmitState();
        });

        let tickRow = document.createElement('div');
        tickRow.style.display = 'flex';
        tickRow.style.justifyContent = 'space-between';
        tickRow.style.textAlign = 'center';
        tickRow.style.width = '500px';
        tickRow.style.fontSize = '14px';
        tickRow.style.marginTop = '4px';
        tickRow.style.flexDirection = 'column';
        tickRow.innerHTML = `
          <span style="flex:1; text-align:center;">Bad</span>
          <span style="flex:1; text-align:center;">Poor</span>
          <span style="flex:1; text-align:center;">Fair</span>
          <span style="flex:1; text-align:center;">Good</span>
          <span style="flex:1; text-align:center;">Excellent</span>
        `;

        // slider.before(tickRow);
      },
      on_finish: () => {
          document.removeEventListener('keydown', handleKey);
      }
    }
  }

  const imageTrials = []
  for (const pair of jsPsych.randomization.shuffle(imagePairs)) {
    imageTrials.push(createImageTrial(pair.evaluation, pair.reference));
  }
  timeline.unshift(preload);
  timeline.push(...imageTrials);
  timeline.push({
    type: jsPsychSurveyHtmlForm,
    html: `
      <h3>Additional Comments</h3>
      <p>Please share any thoughts or feedback about the experiment:</p>
      <textarea
        name="comments"
        rows="10"
        cols="80"
        placeholder="Type your comments here..."
        style="width: 90%; height: 200px; font-size: 16px;"
      ></textarea>
    `,
    button_label: 'Submit'
  });

  jsPsych.run(timeline);

</script>

</html>