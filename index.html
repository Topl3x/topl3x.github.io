<!DOCTYPE html>
<html>

<head>
  <title>Perceptual Study</title>
  <script src="https://unpkg.com/jspsych@8.2.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@2.1.0"></script>
  <link href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css" rel="stylesheet" type="text/css" />
</head>

<body></body>

<script>
  const sheetURL = 'https://script.google.com/macros/s/AKfycbx8mwFKl1WHv84QkM4LblyCeo4UOBasZub5rMwazom52bwJ1ydoXuT0Sa4XGC0jLNgvxw/exec';
  const jsPsych = initJsPsych({
    show_progress_bar: true,
    on_finish: function () {
      document.body.innerHTML = `
        <div style="max-width:700px;margin:40px auto;font-family:system-ui;text-align:center">
          <h2>Saving your responsesâ€¦</h2>
          <p>Please don't close this tab.</p>
        </div>`;
      const data = jsPsych.data.get().json();
      fetch(sheetURL, {
        method: 'POST',
        // mode: 'no-cors',
        headers: {
          'Content-Type': 'text/plain'
        },
        body: data,
        keepalive: true
      }).finally(() => {
        window.location.replace('thankyou.html');
      });
      // jsPsych.data.displayData();
    }
  });

  jsPsych.data.addProperties({
    screen_width:  screen.width,
    screen_height: screen.height,
    window_width:  window.innerWidth,
    window_height: window.innerHeight,
    device_pixel_ratio: window.devicePixelRatio,
    user_agent: navigator.userAgent,
    device: /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent) ? 'mobile' : 'desktop'
  });

  const timeline = [];

  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <h2>Welcome!</h2>
      <p>This study explores visual perception of rendered avatars. It will take about 5 minutes.</p>
      <p>Your task is to rate each image on a scale of 0-100 by comparing a toggleable reference image.</p>
      <p>By continuing, you consent to participate anonymously.</p>
    `,
    choices: ['I Agree']
  });

  timeline.push({
    type: jsPsychSurveyHtmlForm,
    html: `
      <p>Gender:
        <select name="gender" required>
          <option value="male">Male</option>
          <option value="female">Female</option>
          <option value="nonbinary">Non-binary</option>
          <option value="other">Other</option>
        </select>
      </p>
      <p>Age: <input name="age" type="number" min="0" max ="120" required></p>
    `,
    button_label: 'Start'
  });

  var preload = {
    type: jsPsychPreload,
    images: [
      'images/A_0_25_0.png',  
      'images/A_0_50_1.png',
      'images/A_0_100.png',   
      'images/B_0_25_2.png',  
      'images/B_0_50_3.png',
      'images/B_0_100.png',   
      'images/B_1_25_4.png',  
      'images/B_1_50_5.png',  
      'images/B_2_25_6.png',  
      'images/B_2_50_7.png', 
      'images/C_0_25_8.png', 
      'images/C_0_50_9.png', 
      'images/C_0_100.png',
      'images/C_1_25_10.png',
      'images/C_1_50_11.png',
      'images/C_2_25_12.png',
      'images/C_2_50_13.png',
      'images/D_0_25_14.png',
      'images/D_0_50_15.png',
      'images/D_0_100.png',
      'images/D_1_25_16.png',
      'images/D_1_50_17.png',
      'images/D_2_25_18.png',
      'images/D_2_50_19.png'
    ]
  }

  const imagePairs = [
    { evaluation: 'images/A_0_25_0.png',  reference: 'images/A_0_100.png' },
    { evaluation: 'images/A_0_50_1.png',  reference: 'images/A_0_100.png' },
    { evaluation: 'images/B_0_25_2.png',  reference: 'images/B_0_100.png' },
    { evaluation: 'images/B_0_50_3.png',  reference: 'images/B_0_100.png' },
    { evaluation: 'images/B_1_25_4.png',  reference: 'images/B_0_100.png' },
    { evaluation: 'images/B_1_50_5.png',  reference: 'images/B_0_100.png' },
    { evaluation: 'images/B_2_25_6.png',  reference: 'images/B_0_100.png' },
    { evaluation: 'images/B_2_50_7.png',  reference: 'images/B_0_100.png' },
    { evaluation: 'images/C_0_25_8.png',  reference: 'images/C_0_100.png' },
    { evaluation: 'images/C_0_50_9.png',  reference: 'images/C_0_100.png' },
    { evaluation: 'images/C_1_25_10.png', reference: 'images/C_0_100.png' },
    { evaluation: 'images/C_1_50_11.png', reference: 'images/C_0_100.png' },
    { evaluation: 'images/C_2_25_12.png', reference: 'images/C_0_100.png' },
    { evaluation: 'images/C_2_50_13.png', reference: 'images/C_0_100.png' },
    { evaluation: 'images/D_0_25_14.png', reference: 'images/D_0_100.png' },
    { evaluation: 'images/D_0_50_15.png', reference: 'images/D_0_100.png' },
    { evaluation: 'images/D_1_25_16.png', reference: 'images/D_0_100.png' },
    { evaluation: 'images/D_1_50_17.png', reference: 'images/D_0_100.png' },
    { evaluation: 'images/D_2_25_18.png', reference: 'images/D_0_100.png' },
    { evaluation: 'images/D_2_50_19.png', reference: 'images/D_0_100.png' }
  ];

  function createImageTrial(evaluation, reference) {
    let handleKey;
    return {
      type: jsPsychHtmlSliderResponse,
      stimulus: `
        <h2>Rate this image</h2>
        <div>
          <button id="ref-btn" type="button">Show reference (SPACE)</button>
        </div>
        <img id="image" src="${evaluation}"/>
        <p>Please compare to reference image.</p>
        <div id="slider-value" style="font-weight:bold;">Value: 50</div>
      `,
      labels: ['0', '20', '40', '60', '80', '100'],
      min: 0,
      max: 100,
      start: 50,
      step: 1,
      slider_width: 500,
      // require_movement: true,
      button_label: 'Continue',

      on_load: () => {
        const img = document.getElementById('image'); // needs to be general
        // img.src = 'test.png'

        const btn = document.getElementById('ref-btn');
        const submitBtn = document.querySelector('.jspsych-btn');
        handleKey = (e) => {
          if(e.code === 'Space') {
            e.preventDefault();
            btn.click();
          }
        };

        document.addEventListener('keydown', handleKey);

        const slider = document.querySelector('input[type="range"]');
        const valueDisplay = document.getElementById('slider-value');

        let showingRef = false;
        let seenRef = false;
        let sliderMoved = false;

        submitBtn.disabled = true;

        function updateSubmitState() {
          submitBtn.disabled = !(sliderMoved && seenRef);
        }

        btn.addEventListener('click', () => {
          showingRef = !showingRef;
          seenRef = true;

          if (showingRef) {
            img.src = reference;
            btn.textContent = 'Show original (SPACE)';
            slider.disabled = true;
            valueDisplay.style.opacity = '0.5';
          } else {
            img.src = evaluation;
            btn.textContent = 'Show reference (SPACE)';
            slider.disabled = false;
            valueDisplay.style.opacity = '1.0';
          }
          updateSubmitState();
        });

        slider.addEventListener('input', () => {
          valueDisplay.textContent = `Value: ${slider.value}`;
          sliderMoved = true;
          updateSubmitState();
        });

        let tickRow = document.createElement('div');
        tickRow.style.display = 'flex';
        tickRow.style.justifyContent = 'space-between';
        tickRow.style.textAlign = 'center';
        tickRow.style.width = '500px';
        tickRow.style.fontSize = '14px';
        tickRow.style.marginTop = '4px';
        tickRow.innerHTML = `
          <span style="flex:1; text-align:center;">Bad</span>
          <span style="flex:1; text-align:center;">Poor</span>
          <span style="flex:1; text-align:center;">Fair</span>
          <span style="flex:1; text-align:center;">Good</span>
          <span style="flex:1; text-align:center;">Excellent</span>
        `;

        slider.before(tickRow);
      },
      on_finish: () => {
          document.removeEventListener('keydown', handleKey);
      }
    }
  }

  const imageTrials = []
  for (const pair of jsPsych.randomization.shuffle(imagePairs)) {
    imageTrials.push(createImageTrial(pair.evaluation, pair.reference));
  }
  timeline.unshift(preload);
  timeline.push(...imageTrials);
  timeline.push({
    type: jsPsychSurveyHtmlForm,
    html: `
      <h3>Additional Comments</h3>
      <p>Please share any thoughts or feedback about the experiment:</p>
      <textarea
        name="comments"
        rows="10"
        cols="80"
        placeholder="Type your comments here..."
        style="width: 90%; height: 200px; font-size: 16px;"
      ></textarea>
    `,
    button_label: 'Submit'
  });

  jsPsych.run(timeline);

</script>

</html>